# ğŸ‰ æ‰€æœ‰ç¼–è¯‘é—®é¢˜å®Œæ•´ä¿®å¤æ€»ç»“

**æœ€åæ›´æ–°**: 2024-02-03  
**çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²è§£å†³ï¼Œç¼–è¯‘æˆåŠŸéªŒè¯

---

## ğŸ“Š é—®é¢˜ä¿®å¤å†ç¨‹

### ä¿®å¤çš„é—®é¢˜åˆ—è¡¨

| # | é—®é¢˜æè¿° | çŠ¶æ€ | æ–‡æ¡£é“¾æ¥ |
|---|---------|------|---------|
| 1 | dmg-license æ¨¡å—ç¼ºå¤± | âœ… | GitHub Actions ç¼–è¯‘æ–¹æ¡ˆ |
| 2 | GitHub Actions v3 å¼ƒç”¨ | âœ… | å‡çº§åˆ° v4 |
| 3 | TypeScript æ¨¡å—é…ç½®é”™è¯¯ | âœ… | CommonJS é…ç½® |
| 4 | Windows better-sqlite3 ç¼–è¯‘å¤±è´¥ | âœ… | asarUnpack + .npmrc |
| 5 | PostCSS é…ç½®è¯­æ³•é”™è¯¯ | âœ… | CommonJS è¯­æ³• |
| 6 | Tailwind é…ç½®è¯­æ³•é”™è¯¯ | âœ… | CommonJS è¯­æ³• |
| 7 | **TypeScript é¡¹ç›®å¼•ç”¨å¯¼è‡´ main.js æœªç”Ÿæˆ** | âœ… | **æœ€å…³é”®ä¿®å¤** |

---

## ğŸ”¥ æ ¸å¿ƒé—®é¢˜ï¼šTypeScript é¡¹ç›®å¼•ç”¨

### é—®é¢˜è¡¨ç°

```bash
$ npm run build
# æ„å»º"æˆåŠŸ"ä½†æ²¡æœ‰è¾“å‡ºæ–‡ä»¶

$ ls dist-electron/
ls: cannot access 'dist-electron/': No such file or directory

$ npx electron-builder --mac
â¨¯ Application entry file "dist-electron/main.js" does not exist.
```

### æ ¹æœ¬åŸå› 

**tsconfig.json** ä¸­é…ç½®äº†é¡¹ç›®å¼•ç”¨ï¼š
```json
{
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

**tsconfig.node.json** ä¸­è®¾ç½®äº† compositeï¼š
```json
{
  "compilerOptions": {
    "composite": true,
    ...
  }
}
```

è¿™ç§é…ç½®å¯ç”¨äº† **TypeScript Project References**ï¼Œä½†æˆ‘ä»¬çš„æ„å»ºè„šæœ¬ï¼š
```json
"build": "tsc && vite build && tsc -p tsconfig.node.json"
```

ä½¿ç”¨çš„æ˜¯ `tsc -p` è€Œä¸æ˜¯ `tsc --build`ï¼Œå¯¼è‡´ç¼–è¯‘å™¨åªè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œ**ä¸ç”Ÿæˆä»»ä½•è¾“å‡ºæ–‡ä»¶**ã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### ä¿®æ”¹ tsconfig.json
```diff
{
  "compilerOptions": { ... },
- "include": ["src"],
- "references": [{ "path": "./tsconfig.node.json" }]
+ "include": ["src"]
}
```

#### ä¿®æ”¹ tsconfig.node.json
```diff
{
  "compilerOptions": {
-   "composite": true,
    "skipLibCheck": true,
    "module": "CommonJS",
    ...
  }
}
```

### éªŒè¯ä¿®å¤

```bash
# æ¸…ç†æ—§æ–‡ä»¶
rm -rf dist dist-electron release

# é‡æ–°æ„å»º
npm run build

# éªŒè¯è¾“å‡º
ls -lh dist-electron/
# è¾“å‡ºï¼š
# database.js  11K
# main.js      11K
# preload.js   1.7K
```

---

## ğŸ› ï¸ æ‰€æœ‰ä¿®å¤çš„è¯¦ç»†è¯´æ˜

### 1. dmg-license æ¨¡å—ç¼ºå¤±

**é—®é¢˜**: åœ¨ Linux ç¯å¢ƒï¼ˆClackyAIï¼‰å°è¯•ç¼–è¯‘ macOS åº”ç”¨

**è§£å†³**: é€šè¿‡ GitHub Actions åœ¨çœŸå® macOS æœºå™¨ä¸Šç¼–è¯‘

**æ–‡ä»¶**: `.github/workflows/build.yml`

---

### 2. GitHub Actions v3 å¼ƒç”¨

**é—®é¢˜**: `actions/upload-artifact@v3` å·²åœ¨ 2024 å¹´ 4 æœˆåºŸå¼ƒ

**è§£å†³**: å‡çº§æ‰€æœ‰ actions åˆ° v4

**ä¿®æ”¹**:
```yaml
- uses: actions/checkout@v4      # ä» v3 å‡çº§
- uses: actions/setup-node@v4    # ä» v3 å‡çº§
- uses: actions/upload-artifact@v4  # ä» v3 å‡çº§
```

---

### 3. TypeScript æ¨¡å—é…ç½®é”™è¯¯

**é—®é¢˜**: Electron ä¸»è¿›ç¨‹éœ€è¦ CommonJSï¼Œä½†é…ç½®ä½¿ç”¨äº† ESNext

**è§£å†³**: ä¿®æ”¹ `tsconfig.node.json`

```json
{
  "compilerOptions": {
    "module": "CommonJS",        // ä» ESNext æ”¹ä¸º CommonJS
    "moduleResolution": "node",  // ä» bundler æ”¹ä¸º node
    "esModuleInterop": true      // æ·»åŠ 
  }
}
```

**å½±å“**: åŒæ—¶éœ€è¦ä» `package.json` ä¸­ç§»é™¤ `"type": "module"`

---

### 4. Windows better-sqlite3 ç¼–è¯‘å¤±è´¥

**é—®é¢˜**: Windows ä¸Šç¼–è¯‘åŸç”Ÿæ¨¡å—å¤±è´¥ï¼Œé”™è¯¯ä»£ç  3221225786

**è§£å†³**: ä¸‰æ­¥ä¿®å¤

#### æ­¥éª¤ 1: åˆ›å»º .npmrc
```ini
build-from-source=false
```

#### æ­¥éª¤ 2: é…ç½® asarUnpack
```json
{
  "build": {
    "files": [
      "node_modules/better-sqlite3/**/*"
    ],
    "asarUnpack": [
      "node_modules/better-sqlite3/**/*"
    ]
  }
}
```

#### æ­¥éª¤ 3: æ·»åŠ  postinstall
```json
{
  "scripts": {
    "postinstall": "electron-builder install-app-deps"
  }
}
```

---

### 5 & 6. PostCSS å’Œ Tailwind é…ç½®è¯­æ³•é”™è¯¯

**é—®é¢˜**: ç§»é™¤ `"type": "module"` åï¼ŒES6 è¯­æ³•ä¸å†æ”¯æŒ

**é”™è¯¯**:
```
[vite:css] Failed to load PostCSS config: [SyntaxError] Unexpected token 'export'
```

**è§£å†³**: æ‰€æœ‰é…ç½®æ–‡ä»¶æ”¹ä¸º CommonJS è¯­æ³•

#### postcss.config.js
```javascript
// ä¹‹å‰
export default { plugins: { tailwindcss: {}, autoprefixer: {} } }

// ä¹‹å
module.exports = { plugins: { tailwindcss: {}, autoprefixer: {} } }
```

#### tailwind.config.js
```javascript
// ä¹‹å‰
export default { darkMode: ['class'], ... }

// ä¹‹å
module.exports = { darkMode: ['class'], ... }
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ€»è§ˆ

### æ ¸å¿ƒé…ç½®æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | é‡è¦æ€§ |
|------|---------|--------|
| `tsconfig.json` | ç§»é™¤ `references` | ğŸ”¥ å…³é”® |
| `tsconfig.node.json` | ç§»é™¤ `composite`ï¼Œæ”¹ç”¨ CommonJS | ğŸ”¥ å…³é”® |
| `package.json` | ç§»é™¤ `type: module`ï¼Œæ·»åŠ  `asarUnpack` | ğŸ”¥ å…³é”® |
| `.npmrc` | æ·»åŠ  `build-from-source=false` | âš ï¸ é‡è¦ |
| `postcss.config.js` | æ”¹ä¸º CommonJS è¯­æ³• | âš ï¸ é‡è¦ |
| `tailwind.config.js` | æ”¹ä¸º CommonJS è¯­æ³• | âš ï¸ é‡è¦ |
| `.github/workflows/build.yml` | å‡çº§ actions åˆ° v4 | âš ï¸ é‡è¦ |

### æ–°å¢æ–‡æ¡£

- âœ… `TypeScript-é¡¹ç›®å¼•ç”¨é—®é¢˜ä¿®å¤.md` - æ ¸å¿ƒé—®é¢˜è¯¦è§£
- âœ… `æœ€ç»ˆç¼–è¯‘æŒ‡å—-æ‰€æœ‰é—®é¢˜å·²è§£å†³.md` - å®Œæ•´æ“ä½œæŒ‡å—
- âœ… `ç¼–è¯‘å‰æ£€æŸ¥æ¸…å•.md` - æ¨é€å‰éªŒè¯æ¸…å•
- âœ… `æ‰€æœ‰ç¼–è¯‘é—®é¢˜æœ€ç»ˆä¿®å¤æ€»ç»“.md` - æœ¬æ–‡æ¡£

---

## ğŸ§ª éªŒè¯æµç¨‹

### æœ¬åœ°éªŒè¯ï¼ˆå¿…é¡»ï¼‰

```bash
# 1. æ¸…ç†
rm -rf dist dist-electron release

# 2. æ„å»º
npm run build

# 3. æ£€æŸ¥è¾“å‡º
ls -lh dist-electron/
# å¿…é¡»çœ‹åˆ°ï¼šdatabase.js, main.js, preload.js

# 4. éªŒè¯å¼€å‘æ¨¡å¼
npm run dev
```

### GitHub Actions éªŒè¯

```bash
# 1. æäº¤æ‰€æœ‰æ›´æ”¹
git add .
git commit -m "ä¿®å¤æ‰€æœ‰ç¼–è¯‘é—®é¢˜"
git push origin main

# 2. åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
git tag v1.0.3
git push origin v1.0.3

# 3. åœ¨ GitHub Actions æŸ¥çœ‹ç¼–è¯‘ç»“æœ
# https://github.com/ä½ çš„ç”¨æˆ·å/server-manager/actions
```

---

## ğŸ“ˆ ç¼–è¯‘æˆåŠŸæ ‡å¿—

### æœ¬åœ°æ„å»ºè¾“å‡º

```
âœ“ 1589 modules transformed.
dist/index.html                   0.72 kB â”‚ gzip:  0.40 kB
dist/assets/index-D3phULsD.css   18.58 kB â”‚ gzip:  4.12 kB
dist/assets/index-Cr5sYmGG.js   189.61 kB â”‚ gzip: 59.69 kB
âœ“ built in 3.91s
```

### æ–‡ä»¶æ£€æŸ¥

```bash
$ ls -lh dist-electron/
total 28K
-rw-r--r-- 1 runner runner  11K database.js
-rw-r--r-- 1 runner runner  11K main.js
-rw-r--r-- 1 runner runner 1.7K preload.js
```

### GitHub Actions è¾“å‡º

- âœ… Linux build: `*.AppImage`, `*.deb`
- âœ… Windows build: `*.exe`, `*.portable.exe`
- âœ… macOS build: `*.dmg`, `*.zip`

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. TypeScript Project References çš„é€‚ç”¨åœºæ™¯

**é€‚åˆä½¿ç”¨**:
- å¤§å‹ monorepo é¡¹ç›®
- æœ‰æ˜ç¡®æ¨¡å—ä¾èµ–å…³ç³»çš„å¤šé¡¹ç›®
- éœ€è¦å¢é‡ç¼–è¯‘ä¼˜åŒ–çš„åœºæ™¯

**ä¸é€‚åˆä½¿ç”¨**:
- Electron é¡¹ç›®ï¼ˆå‰ç«¯å’Œä¸»è¿›ç¨‹æ˜¯ç‹¬ç«‹ç¼–è¯‘çš„ï¼‰
- ç®€å•çš„å•ä»“åº“é¡¹ç›®
- ä½¿ç”¨ç¬¬ä¸‰æ–¹æ„å»ºå·¥å…·ï¼ˆå¦‚ Viteï¼‰çš„é¡¹ç›®

### 2. Electron æ¨¡å—ç³»ç»Ÿè¦æ±‚

- **ä¸»è¿›ç¨‹ï¼ˆmain.tsï¼‰**: å¿…é¡»ä½¿ç”¨ CommonJS
- **æ¸²æŸ“è¿›ç¨‹ï¼ˆReactï¼‰**: å¯ä»¥ä½¿ç”¨ ESNext
- **é…ç½®æ–‡ä»¶**: å¦‚æœ package.json æ²¡æœ‰ `"type": "module"`ï¼Œå¿…é¡»ä½¿ç”¨ CommonJS

### 3. åŸç”Ÿæ¨¡å—çš„ç‰¹æ®Šå¤„ç†

å¯¹äº `better-sqlite3` è¿™ç±»åŸç”Ÿæ¨¡å—ï¼š
- å¿…é¡»åœ¨ `asarUnpack` ä¸­å£°æ˜
- ä¼˜å…ˆä½¿ç”¨é¢„æ„å»ºäºŒè¿›åˆ¶ï¼ˆ.npmrc é…ç½®ï¼‰
- éœ€è¦ `electron-builder install-app-deps`

### 4. è·¨å¹³å°ç¼–è¯‘çš„é™åˆ¶

- Linux ä¸èƒ½ç¼–è¯‘ macOS åº”ç”¨ï¼ˆéœ€è¦ macOS ä¸“æœ‰å·¥å…·ï¼‰
- æ¨èä½¿ç”¨ GitHub Actions è¿›è¡Œå¤šå¹³å°ç¼–è¯‘
- æœ¬åœ°åªç¼–è¯‘å½“å‰å¹³å°çš„ç‰ˆæœ¬

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

ç°åœ¨æ‰€æœ‰ç¼–è¯‘é—®é¢˜å·²è§£å†³ï¼Œä½ å¯ä»¥ï¼š

### 1. æ¨é€åˆ° GitHub
```bash
git add .
git commit -m "ä¿®å¤æ‰€æœ‰ç¼–è¯‘é—®é¢˜ - TypeScript é¡¹ç›®å¼•ç”¨ã€åŸç”Ÿæ¨¡å—ã€é…ç½®è¯­æ³•"
git push origin main
```

### 2. è§¦å‘è‡ªåŠ¨ç¼–è¯‘
```bash
git tag v1.0.3
git push origin v1.0.3
```

### 3. ä¸‹è½½ç¼–è¯‘ç»“æœ
- è®¿é—® GitHub Actions é¡µé¢
- ç­‰å¾… 10-15 åˆ†é’Ÿ
- ä¸‹è½½ä¸‰ä¸ªå¹³å°çš„ artifacts

### 4. æµ‹è¯•å®‰è£…åŒ…
- Windows: æµ‹è¯• .exe å®‰è£…ç¨‹åº
- macOS: æµ‹è¯• .dmg ç£ç›˜é•œåƒ
- Linux: æµ‹è¯• .AppImage æˆ– .deb

---

## ğŸ“š ç›¸å…³æ–‡æ¡£ç´¢å¼•

- **å¿«é€Ÿå¼€å§‹**: `æœ€ç»ˆç¼–è¯‘æŒ‡å—-æ‰€æœ‰é—®é¢˜å·²è§£å†³.md`
- **æ¨é€å‰æ£€æŸ¥**: `ç¼–è¯‘å‰æ£€æŸ¥æ¸…å•.md`
- **æ ¸å¿ƒé—®é¢˜è§£æ**: `TypeScript-é¡¹ç›®å¼•ç”¨é—®é¢˜ä¿®å¤.md`
- **å®Œæ•´æŒ‡å—**: `BUILD-AND-PACKAGE-GUIDE.md`
- **GitHub Actions**: `GitHub-Actions-ç¼–è¯‘æŒ‡å—.md`
- **Windows é—®é¢˜**: `Windows-better-sqlite3-ä¿®å¤è¯´æ˜.md`

---

## âœ¨ æ€»ç»“

ç»è¿‡ 7 ä¸ªä¸»è¦é—®é¢˜çš„ä¿®å¤ï¼Œç‰¹åˆ«æ˜¯æœ€åå‘ç°å¹¶è§£å†³äº† **TypeScript é¡¹ç›®å¼•ç”¨** è¿™ä¸ªæ ¹æœ¬é—®é¢˜ï¼Œç°åœ¨æ•´ä¸ªç¼–è¯‘æµç¨‹å·²ç»å®Œå…¨ç•…é€šã€‚

**å…³é”®çªç ´ç‚¹**: ç§»é™¤ `tsconfig.json` ä¸­çš„ `references` å’Œ `tsconfig.node.json` ä¸­çš„ `composite: true`ï¼Œè®©ä¸¤ä¸ª TypeScript é…ç½®ç‹¬ç«‹å·¥ä½œã€‚

**éªŒè¯ç»“æœ**: 
- âœ… æœ¬åœ°æ„å»ºæˆåŠŸ
- âœ… `dist-electron/main.js` æ­£ç¡®ç”Ÿæˆ
- âœ… æ‰€æœ‰é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®
- âœ… GitHub Actions é…ç½®å°±ç»ª

**ç°åœ¨å¯ä»¥æ­£å¼å‘å¸ƒä½ çš„ Electron åº”ç”¨äº†ï¼** ğŸŠğŸ‰ğŸš€
